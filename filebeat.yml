filebeat.config:
    modules:
        path: ${path.config}/modules.d/*.yml
        reload.enabled: false

# 输入配置：Docker 容器日志
filebeat.inputs:
    - type: container
      enabled: true
      paths:
          - "/var/lib/docker/containers/*/*.log"
      # 限定收集的容器（根据容器名或服务名）
      containers:
          ids:
              - "im_message_test" # 您的应用容器
              - "redis_im" # Redis 容器
              - "mysql_im" # MySQL 容器
      # 元数据增强
      processors:
          - add_docker_metadata:
                host: "unix:///var/run/docker.sock"
                match_fields: ["container.name"]
          - add_fields:
                target: ""
                fields:
                    env: "production"
                    log_type: "docker"
      fields_under_root: true
      # 多行日志处理（如堆栈跟踪）
      multiline:
          pattern: '^\d{4}-\d{2}-\d{2}' # 匹配时间戳开头的行
          negate: true
          match: after
          max_lines: 500
          timeout: 2s
      # 文件处理策略
      ignore_older: 24h
      close_inactive: 2h
      clean_removed: true
      scan_frequency: 10s

    # 输入配置：应用程序日志文件
    - type: log
      enabled: true
      paths:
          - "/var/log/app/*.log"
          - "/var/log/app/*.json"
      fields:
          log_type: "app"
          service: "im_message"
      fields_under_root: true
      # JSON 日志解析
      json:
          keys_under_root: true
          overwrite_keys: true
          message_key: "message"
      # 文件处理策略
      close_inactive: 1h
      ignore_older: 48h
      tail_files: false

# 输出配置：Elasticsearch
output.elasticsearch:
    hosts: ["elasticsearch:9200"]
    # 按日志类型分索引
    indices:
        - index: "im-message-docker-%{+yyyy.MM.dd}"
          when.equals:
              log_type: "docker"
        - index: "im-message-app-%{+yyyy.MM.dd}"
          when.equals:
              log_type: "app"
    # 性能优化
    bulk_max_size: 512
    worker: 4
    compression_level: 3

# Kibana 仪表板初始化
setup.kibana:
    host: "kibana:5601"
setup.dashboards:
    enabled: true

# 索引模板配置
setup.template:
    name: "im-message"
    pattern: "im-message-*"
    settings:
        index.number_of_shards: 2
        index.codec: best_compression

# 监控 Filebeat 自身状态
monitoring:
    enabled: true
    elasticsearch:
        hosts: ["elasticsearch:9200"]

# 日志记录（调试用）
logging.level: info
logging.to_files: true
logging.files:
    path: /var/log/filebeat
    name: filebeat.log
    keepfiles: 7
